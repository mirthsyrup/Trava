<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Компендиум Травника</title>
    <!-- Подключаем Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключаем шрифт Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Применяем шрифт Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Стили для кастомного скроллбара */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-full overflow-y-auto">

    <div class="container max-w-7xl mx-auto p-4 md:p-8">
        <h1 class="text-4xl font-bold text-center text-green-400 mb-8">Компендиум Травника</h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- ЛЕВАЯ КОЛОНКА: Настройки и Действия -->
            <div class="lg:col-span-1 space-y-6 lg:sticky lg:top-8 lg:self-start">
                
                <!-- Блок Настроек Поиска -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold text-green-400 mb-4 border-b border-gray-700 pb-2">Настройки Поиска</h2>
                    
                    <!-- Фильтр Местности -->
                    <div>
                        <label for="location-filter" class="block text-sm font-medium text-gray-300 mb-2">Текущая Местность:</label>
                        <select id="location-filter" class="block w-full bg-gray-700 border-gray-600 rounded-md p-2 text-white focus:ring-green-500 focus:border-green-500">
                            <!-- ИЗМЕНЕНЫ ОПЦИИ -->
                            <option value="povsemestno">Повсеместно</option>
                            <option value="pustyni">Пустыни</option>
                            <option value="luga">Луга</option>
                            <option value="lesa">Леса</option>
                            <option value="poberezhje">Побережье/Берега</option>
                            <option value="bolota">Болота</option>
                            <option value="holmy">Холмы</option>
                            <option value="arktika">Арктика</option>
                            <option value="podzemje">Подземье</option>
                            <option value="gory">Горы</option>
                            <option value="special">Специальные (Сбор)</option>
                        </select>
                    </div>

                    <!-- Переключатель Ночь/День (ОСТАВЛЕН ПО ПРОСЬБЕ) -->
                    <!-- *** ИСПРАВЛЕНИЕ 1: Восстановлен поврежденный HTML-код переключателя *** -->
                    <div class="mt-4">
                        <label for="night-toggle" class="flex items-center cursor-pointer">
                            <div class="relative">
                                <input type="checkbox" id="night-toggle" class="sr-only">
                                <!-- 'bar' - фон меняется скриптом -->
                                <div class="block w-14 h-8 rounded-full transition-colors duration-300"></div>
                                <!-- 'dot' - точка меняется скриптом -->
                                <div class="dot absolute left-1 top-1 w-6 h-6 rounded-full transition-all duration-300"></div>
                            </div>
                            <div class="ml-3 text-gray-300 font-medium" id="time-label">День</div>
                        </label>
                    </div>
                </div>

                <!-- Блок Сбора Растений -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold text-green-400 mb-4">Поиск и Сбор</h2>
                    
                    <!-- Кнопка Поиска -->
                    <button id="search-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-md">
                        Бросить d20 для **поиска**
                    </button>
                    <div class="text-center mt-4">
                        <p class="text-lg">Результат Поиска d20: <span id="search-d20-result" class="font-bold text-2xl text-yellow-300">-</span></p>
                    </div>
                    
                    <h3 class="text-xl font-semibold text-gray-200 mt-6 mb-2">Результаты Поиска:</h3>
                    <div id="search-results-display" class="min-h-[100px] bg-gray-700 p-4 rounded-lg border border-gray-600 text-gray-300 overflow-y-auto max-h-[200px]">
                        <p class="italic text-gray-400">Нажмите кнопку, чтобы найти растения...</p>
                    </div>

                    <!-- Разделитель -->
                    <hr class="border-gray-600 my-6">

                    <!-- Кнопка Сбора -->
                    <button id="gather-btn" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-md cursor-not-allowed opacity-50">
                        Бросить d20 для **сбора**
                    </button>
                    <div class="text-center mt-4">
                        <p class="text-lg">Результат Сбора d20: <span id="gather-d20-result" class="font-bold text-2xl text-yellow-300">-</span></p>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-200 mt-6 mb-2">Собранная Добыча:</h3>
                    <div id="loot-display" class="min-h-[100px] bg-gray-700 p-4 rounded-lg border border-gray-600 text-gray-300 overflow-y-auto max-h-[200px]">
                        <p class="italic text-gray-400">Ожидание сбора...</p>
                    </div>
                </div>

                <!-- Блок Броска Кубиков -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold text-indigo-400 mb-4">Броски Кубиков</h2>
                    
                    <!-- Поле для множителя -->
                    <div class="mb-4">
                        <label for="dice-multiplier" class="block text-sm font-medium text-gray-300 mb-2">Количество (Множитель):</label>
                        <!-- Заменяем input на select -->
                        <select id="dice-multiplier" class="block w-full bg-gray-700 border-gray-600 rounded-md p-2 text-white focus:ring-indigo-500 focus:border-indigo-500">
                            <!-- Опции от 1 до 30 будут добавлены скриптом -->
                        </select>
                    </div>

                    <div class="grid grid-cols-3 gap-3">
                        <button data-die="4" class="dice-btn bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow">d4</button>
                        <button data-die="6" class="dice-btn bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow">d6</button>
                        <button data-die="8" class="dice-btn bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow">d8</button>
                        <button data-die="10" class="dice-btn bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow">d10</button>
                        <button data-die="12" class="dice-btn bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow">d12</button>
                        <button data-die="20" class="dice-btn bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow">d20</button>
                    </div>
                    <p class="text-center text-lg mt-4">Результат: <span id="dice-result" class="font-bold text-2xl text-yellow-300">-</span></p>
                </div>
            </div>

            <!-- ПРАВАЯ КОЛОНКА: Компендиум -->
            <div class="lg:col-span-2">
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-3xl font-bold text-green-400 mb-4">Компендиум</h2>
                    
                    <!-- Фильтр Категорий -->
                    <div>
                        <label for="category-filter" class="block text-sm font-medium text-gray-300 mb-2">Фильтр по Категории:</label>
                        <select id="category-filter" class="block w-full md:w-1/2 bg-gray-700 border-gray-600 rounded-md p-2 text-white focus:ring-green-500 focus:border-green-500">
                            <!-- ИЗМЕНЕНЫ ОПЦИИ -->
                            <option value="all">Все Категории</option>
                            <option value="potion">Ингредиенты Зелий</option>
                            <option value="poison">Ингредиенты Ядов</option>
                            <option value="magic_potion">Ингредиенты Магических Зелий</option>
                        </select>
                    </div>

                    <!-- Контейнер для списка растений -->
                    <div id="plant-list-container" class="mt-6 space-y-6">
                        <!-- Сюда будет рендериться список растений -->
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- БАЗА ДАННЫХ РАСТЕНИЙ ---
        // Rarity: 'common', 'uncommon', 'rare', 'very_rare'
        // Time: 'any' (по просьбе пользователя механика оставлена)
        // Locations: 'povsemestno', 'pustyni', 'luga', 'lesa', 'poberezhje', 'bolota', 'holmy', 'arktika', 'podzemje', 'gory', 'special'
        // Category: 'potion' (Зелья), 'poison' (Яды), 'magic_potion' (Магические зелья)
        const plantDatabase = [
            // ----- ИНГРЕДИЕНТЫ ЗЕЛИЙ (Из image_c1f62a.jpg) -----
            { id: 1, name: "Кровьтрава", category: "potion", locations: ["povsemestno"], time: "any", rarity: "common", description: "Эффект: Может быть смешано с любым другим ингредиентом, содержащим Эффект Зелья, чтобы стать источником еды на 1 день. Неизменяемый." },
            { id: 2, name: "Хромовая слизь", category: "potion", locations: ["poberezhje", "podzemje"], time: "any", rarity: "rare", description: "Специальный (модификатор): Итоговый Эффект после всех вычислений становится абсолютно противоположным. Это зависит от Мастера, относительно каждого зелья/яда." },
            { id: 3, name: "Сушёная Эфедра", category: "potion", locations: ["pustyni", "gory"], time: "any", rarity: "uncommon", description: "Модификатор: Увеличивает тип кости на 1 для одного исцеляющего эффекта." },
            { id: 4, name: "Рвоск", category: "potion", locations: ["lesa", "bolota"], time: "any", rarity: "common", description: "Специальный (модификатор): Задерживает Эффект действия ингредиентов на 1d6 раундов." },
            { id: 5, name: "Фенхелёвый шёлк", category: "potion", locations: ["arktika", "podzemje"], time: "any", rarity: "common", description: "Эффект: Стабилизирует температуру тела, чтобы выдержать холод или влажность на 1 час. Неизменяемый." },
            { id: 6, name: "Кисть Генгкоу", category: "potion", locations: ["holmy", "podzemje"], time: "any", rarity: "uncommon", description: "Модификатор: Удваивает кол-во костей при броске любого исцеляющего эффекта. Эффект исцеления делится пополам на два раунда и срабатывает в конце вашего хода." },
            { id: 7, name: "Нектар Гиацинта", category: "potion", locations: ["poberezhje", "luga"], time: "any", rarity: "common", description: "Эффект: Уменьшает на 1d6 раундов эффект яда на цели, однако не может убрать его полностью, один раунд все равно будет нанесен урон от яда." },
            { id: 8, name: "Веточка лаванды", category: "potion", locations: ["poberezhje", "luga", "holmy"], time: "any", rarity: "common", description: "Специальный (модификатор): Делает зелье или яд более стабильный для его безопасного создания. Накапливаемый до 3." },
            { id: 9, name: "Корень Мандрагоры", category: "potion", locations: ["povsemestno"], time: "any", rarity: "common", description: "Эффект: Ослабляет любую болезнь или яд наполовину в течении 2к12 часов. Препятствует только уже существующим ядам или заболеваниям. Неизменяемый." },
            { id: 10, name: "Семена Молочая", category: "potion", locations: ["povsemestno"], time: "any", rarity: "common", description: "Модификатор: Удваивает кол-во костей при броске любого исцеляющего эффекта, но убирает модификатор Алхимии." },
            { id: 11, name: "Корень дикого Шалфея", category: "potion", locations: ["povsemestno"], time: "any", rarity: "common", description: "Эффект: Исцеляет 2к4 + Модификатор Алхимии. Накапливаемый до 5." },

            // ----- ИНГРЕДИЕНТЫ ЯДОВ (Из image_c1f644.jpg) -----
            { id: 12, name: "Арктический плющ", category: "poison", locations: ["arktika", "gory"], time: "any", rarity: "common", description: "Модификатор: Заменяет урон ядом на холод или урон некротической энергией; цель становится отравлена на 1 минуту при провале спасброска Телосложения. Комбинируемый." },
            { id: 13, name: "Шляпка мухомора", category: "poison", locations: ["poberezhje", "bolota"], time: "any", rarity: "common", description: "Модификатор: Меняет любой эффект яда на не летальный, цель падает без сознания." },
            { id: 14, name: "Дыхание Василиска", category: "poison", locations: ["gory"], time: "any", rarity: "very_rare", description: "Эффект: Медленно парализует врага. Цель должна совершать спасбросок Телосложения каждый ход в течении 4-х ходов. Пока цель находится под действием этого эффекта, то она считается замедленной, как при наложении заклинания Замедление. При провале спасброска цель парализуется на 4 часа. Не комбинируемый. Неизменяемый." },
            { id: 15, name: "Сок кактуса", category: "poison", locations: ["pustyni", "luga"], time: "any", rarity: "common", description: "Модификатор: Цель не получает никакого урона от яда и не замечает его действия, пока не пройдет 5 ходов с момента начала действия яда. После этого цель получает урон за все прошедшие ходы единовременно. Агрегатный." },
            // Хромовая слизь (ID 2) уже добавлена.
            { id: 16, name: "Цветы Дракуса", category: "poison", locations: ["pustyni", "luga", "gory"], time: "any", rarity: "common", description: "Модификатор: Изменяет урон от яда на огненный или кислотный урон; цель всё еще отравлена на 1 мин. при провале спасброска Телосложения. Комбинируемый." },
            // Рвоск (ID 4) уже добавлен.
            { id: 17, name: "Морозные бобы", category: "poison", locations: ["arktika", "gory"], time: "any", rarity: "rare", description: "Модификатор: Когда цель отравлена, её скорость падает на 10 футов на 1 минуту. Неизменяемый." },
            
            // *** ИЗМЕНЕНИЕ 1 ***
            { id: 18, name: "Листья Харрады", category: "poison", locations: ["lesa", "luga", "holmy"], time: "any", rarity: "common", description: "Эффект/Модификатор: Пока отравлена, цель имеет помехи на проверки. Неизменяемый." },

            // ----- ИНГРЕДИЕНТЫ ЯДОВ (Из image_c1f649.jpg) -----
            { id: 19, name: "Ртутный мох", category: "poison", locations: ["povsemestno"], time: "any", rarity: "uncommon", description: "Модификатор: Удваивает кол-во костей на любой Эффект яда, но уменьшает время действия Эффекта вдвое. Комбинируемый." },
            { id: 20, name: "Сияющий синтоцвет", category: "poison", locations: ["podzemje"], time: "any", rarity: "rare", description: "Модификатор: Изменяет урон ядом на урон от света; цель всё еще отравлена на 1 минуту при провале спасброска Телосложения. Комбинируемый." },
            { id: 21, name: "Ягоды шиповцета", category: "poison", locations: ["pustyni", "bolota"], time: "any", rarity: "uncommon", description: "Специальный (модификатор): Увеличивает тип кости на 1 за любой Модификатор. Для чар увеличивает ранг заклинания." },
            { id: 22, name: "Лепестки языка вирма", category: "poison", locations: ["povsemestno"], time: "any", rarity: "common", description: "Эффект: 1к4 + Мод. Алхимии урона ядом за атаку. Цель считается отравленной на 1 минуту. Накапливаемый до 5." },
            { id: 23, name: "Яд василиска", category: "poison", locations: ["special"], time: "any", rarity: "very_rare", description: "Эффект (спасбросок): 5к6 + Мод. Алхимии урона ядом за атаку или за раунд, если сделан как агрегатный. Цель становится отравлена на 1 минуту при провале спасброска Телосложения. Агрегатный." },
            { id: 24, name: "Яд гигантских ос", category: "poison", locations: ["special"], time: "any", rarity: "rare", description: "Эффект (спасбросок): 3к6 + Мод. Алхимии урона ядом за атаку или за раунд, если сделан как агрегатный. Цель становится отравлена на 1 минуту при провале спасброска Телосложения. Агрегатный." },
            { id: 25, name: "Яд гигантских скорпионов", category: "poison", locations: ["special"], time: "any", rarity: "rare", description: "Эффект (спасбросок): 4к10 + Мод. Алхимии урона ядом за атаку или за раунд, если сделан как агрегатный. Накапливаемый до 4. Агрегатный." },
            
            // ----- ИНГРЕДИЕНТЫ МАГИЧЕСКИХ ЗЕЛИЙ (Из image_c1f64d.jpg) -----
            { id: 26, name: "Корень Стрела", category: "magic_potion", locations: ["pustyni", "luga", "lesa"], time: "any", rarity: "uncommon", description: "Магия: +1 к броскам атаки, когда используется на оружие." },
            { id: 27, name: "Синий Кривожаб", category: "magic_potion", locations: ["poberezhje", "lesa", "bolota"], time: "any", rarity: "rare", description: "Магия: Игрок создаёт Зелье газообразной формы." },
            
            // *** ИЗМЕНЕНИЕ 2 ***
            { id: 28, name: "Ко-Глонд", category: "magic_potion", locations: ["pustyni", "poberezhje"], time: "any", rarity: "rare", description: "Магия: Игрок создаёт Зелье ясновидения." },
            
            { id: 29, name: "Дьявольский кроволист", category: "magic_potion", locations: ["holmy", "bolota", "podzemje"], time: "any", rarity: "very_rare", description: "Магия: Игрок создаёт Зелье живучести." },
            
            // *** ИЗМЕНЕНИЕ 3 ***
            { id: 30, name: "Элементальная вода", category: "magic_potion", locations: ["povsemestno", "gory", "bolota", "podzemje"], time: "any", rarity: "rare", description: "Модификатор (Магия): Ингредиент, требуемый для всех Магических зелий." },

            { id: 31, name: "Дьявольский плющ", category: "magic_potion", locations: ["arktika", "podzemje"], time: "any", rarity: "rare", description: "Магия: Игрок создаёт Зелье чтения мыслей." },
            { id: 32, name: "Водоподох", category: "magic_potion", locations: ["poberezhje", "bolota"], time: "any", rarity: "uncommon", description: "Магия: Игрок создаёт Зелье подводного дыхания." },
            { id: 33, name: "Сердце Желеодрева", category: "magic_potion", locations: ["arktika", "lesa", "holmy"], time: "any", rarity: "uncommon", description: "Магия: Игрок создаёт Зелье увеличения." },
            { id: 34, name: "Светопыль шляпки", category: "magic_potion", locations: ["gory", "podzemje"], time: "any", rarity: "rare", description: "Магия: Игрок создаёт Зелье героизма." },
            { id: 35, name: "Порошок мэрипоти", category: "magic_potion", locations: ["arktika", "podzemje"], time: "any", rarity: "very_rare", description: "Магия: Игрок создаёт Зелье долголетия." },
            { id: 36, name: "Ягоды Паслёна", category: "magic_potion", locations: ["lesa", "holmy"], time: "any", rarity: "uncommon", description: "Магия: Игрок создаёт Масло ускользания." },
            { id: 37, name: "Изначальный бальзам", category: "magic_potion", locations: ["gory", "bolota", "podzemje"], time: "any", rarity: "rare", description: "Магия: Игрок создаёт Зелье силы великана." },
            { id: 38, name: "Каменный вьюн", category: "magic_potion", locations: ["holmy", "gory"], time: "any", rarity: "rare", description: "Магия: Игрок создаёт Зелье неуязвимости." },
            { id: 39, name: "Бобы Суили", category: "magic_potion", locations: ["pustyni", "luga"], time: "any", rarity: "common", description: "Магия: Игрок создаёт Зелье лазанья." },
            { id: 40, name: "Серебряный гибискус", category: "magic_potion", locations: ["arktika", "podzemje"], time: "any", rarity: "rare", description: "Магия: При употреблении позволяет использовать случайное элементальное дыхание 3 раза. Неизменяемый." },
            { id: 41, name: "Листохвост", category: "magic_potion", locations: ["luga", "holmy"], time: "any", rarity: "very_rare", description: "Магия: Игрок создаёт Зелье скорости." },
            { id: 42, name: "Вердинская крапива", category: "magic_potion", locations: ["lesa"], time: "any", rarity: "uncommon", description: "Магия: Игрок создаёт Зелье дружбы с животными." },
            { id: 43, name: "Корень пустоты", category: "magic_potion", locations: ["arktika", "pustyni"], time: "any", rarity: "very_rare", description: "Магия: Игрок создаёт Зелье полёта." },
            { id: 44, name: "Стебли Гифломы", category: "magic_potion", locations: ["lesa", "podzemje"], time: "any", rarity: "very_rare", description: "Магия: Игрок создаёт Зелье невидимости." },
            { id: 45, name: "Зловонная луковица", category: "magic_potion", locations: ["poberezhje", "bolota"], time: "any", rarity: "rare", description: "Магия: Игрок создаёт Зелье уменьшения." },
            // Ягоды шиповцета (ID 21) уже добавлены.
        ];

        // --- Глобальные Элементы DOM ---
        let locationFilter, nightToggle, timeLabel, categoryFilter;
        let searchBtn, searchD20ResultEl, searchResultsDisplayEl;
        let gatherBtn, gatherD20ResultEl, lootDisplayEl;
        let diceResultEl, diceMultiplierEl; // Добавляем diceMultiplierEl
        let plantListContainerEl;

        // --- Глобальное Состояние ---
        let potentialLoot = [];

        // --- ИНИЦИАЛИЗАЦИЯ ---
        document.addEventListener('DOMContentLoaded', () => {
            // Инициализация элементов
            locationFilter = document.getElementById('location-filter');
            nightToggle = document.getElementById('night-toggle');
            timeLabel = document.getElementById('time-label');
            categoryFilter = document.getElementById('category-filter');
            
            // Элементы Поиска
            searchBtn = document.getElementById('search-btn');
            searchD20ResultEl = document.getElementById('search-d20-result');
            searchResultsDisplayEl = document.getElementById('search-results-display');
            
            // Элементы Сбора
            gatherBtn = document.getElementById('gather-btn');
            gatherD20ResultEl = document.getElementById('gather-d20-result');
            lootDisplayEl = document.getElementById('loot-display');
            
            // Другие элементы
            diceResultEl = document.getElementById('dice-result');
            diceMultiplierEl = document.getElementById('dice-multiplier'); // Находим новый select
            plantListContainerEl = document.getElementById('plant-list-container');
            
            // --- ЗАПОЛНЕНИЕ ВЫПАДАЮЩЕГО СПИСКА МНОЖИТЕЛЯ ---
            // Динамически создаем опции от 1 до 30
            for (let i = 1; i <= 30; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                diceMultiplierEl.appendChild(option);
            }

            // --- ОБРАБОТЧИКИ СОБЫТИЙ ---

            // Переключатель Ночь/День
            nightToggle.addEventListener('change', () => {
                const isNight = nightToggle.checked;
                const dot = nightToggle.nextElementSibling.nextElementSibling;
                const bar = dot.previousElementSibling;

                // Удаляем старые классы
                bar.classList.remove('bg-gray-600', 'bg-yellow-400', 'bg-indigo-800');
                dot.classList.remove('bg-white', 'bg-yellow-100', 'bg-blue-200');

                if (isNight) {
                    // Ночь (луна)
                    timeLabel.textContent = 'Ночь';
                    dot.style.transform = 'translateX(1.5rem)';
                    bar.classList.add('bg-indigo-800');
                    dot.classList.add('bg-blue-200');
                } else {
                    // День (солнце)
                    timeLabel.textContent = 'День';
                    dot.style.transform = 'translateX(0)';
                    bar.classList.add('bg-yellow-400');
                    dot.classList.add('bg-yellow-100');
                }
                renderPlantList(); // Обновляем компандиум
            });

            // Фильтры Компендиума
            locationFilter.addEventListener('change', renderPlantList);
            categoryFilter.addEventListener('change', renderPlantList);

            // Кнопка Поиска (бывший Сбор)
            searchBtn.addEventListener('click', handleSearchRoll);

            // Кнопка Сбора (новая)
            gatherBtn.addEventListener('click', handleGatherRoll);

            // Кнопки Обычных Кубиков
            document.querySelectorAll('.dice-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const sides = parseInt(button.dataset.die, 10);
                    const multiplier = parseInt(diceMultiplierEl.value, 10) || 1; // Получаем множитель
                    
                    let totalSum = 0;
                    for (let i = 0; i < multiplier; i++) {
                        totalSum += rollDice(sides); // Суммируем броски
                    }
                    
                    diceResultEl.textContent = totalSum; // Показываем сумму
                });
            });

            // --- НОВЫЙ ОБРАБОТЧИК ДЛЯ КАРТОЧЕК-АККОРДЕОНОВ ---
            // Используем делегирование событий, чтобы слушать клики на контейнере
            plantListContainerEl.addEventListener('click', (e) => {
                // Находим кнопку, по которой кликнули (или ее родителя)
                const toggleButton = e.target.closest('.plant-toggle-btn');
                if (!toggleButton) return; // Клик был не по кнопке

                // Находим следующий элемент (это наш блок с деталями)
                const details = toggleButton.nextElementSibling;
                
                // Переключаем класс 'hidden'
                if (details) {
                    details.classList.toggle('hidden');
                }
            });

            // Первоначальная отрисовка Компендиума
            renderPlantList();
            
            // Инициализация стиля переключателя
            nightToggle.dispatchEvent(new Event('change'));
            // Инициализация кнопки сбора
            gatherBtn.disabled = true;
        });

        // --- ОСНОВНЫЕ ФУНКЦИИ ---

        /**
         * Бросает кубик с заданным количеством граней.
         * @param {number} sides - Количество граней (4, 6, 8, 10, 12, 20)
         * @returns {number} - Результат броска (1-sides)
         */
        function rollDice(sides) {
            return Math.floor(Math.random() * sides) + 1;
        }

        /**
         * Возвращает CSS-класс для редкости растения.
         * @param {string} rarity - "common", "uncommon", "rare", "very_rare"
         * @returns {string} - Tailwind классы
         */
        function getRarityClass(rarity) {
            switch (rarity) {
                case 'common': return 'bg-gray-500 text-gray-100';
                case 'uncommon': return 'bg-blue-600 text-white';
                case 'rare': return 'bg-purple-600 text-white';
                case 'very_rare': return 'bg-yellow-500 text-gray-900 font-bold';
                default: return 'bg-gray-400 text-gray-900';
            }
        }

        /**
         * НОВАЯ ФУНКЦИЯ: Возвращает SVG-иконку для категории.
         * @param {string} category - "potion", "poison", "magic_potion"
         * @returns {string} - HTML-строка с SVG
         */
        function getCategoryIcon(category) {
            // Иконки взяты из Heroicons (https://heroicons.com/)
            const icons = {
                // Иконка для Зелий (бутылка)
                'potion': `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-blue-400">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.05 4.575a1.575 1.575 0 1 0-3.15 0v3m3.15-3v-1.5a1.575 1.575 0 0 1 3.15 0v1.5m-3.15 0 .075.075a1.575 1.575 0 0 0 2.25 2.25l.075.075v-4.875M10.05 4.575h.008v.008h-.008v-.008Zm-3.15 0h.008v.008h-.008v-.008Zm0 9a1.5 1.5 0 0 0-1.5 1.5v5.25a1.5 1.5 0 0 0 1.5 1.5h3a1.5 1.5 0 0 0 1.5-1.5v-5.25a1.5 1.5 0 0 0-1.5-1.5h-3Zm0 3h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Zm3-3h.008v.008h-.008v-.008Z" />
                    </svg>`,
                // Иконка для Ядов (череп)
                'poison': `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-red-400">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M11.412 15.655 9.75 12.75l-1.662 2.905m-1.662-2.905L4.764 12.75l-1.662 2.905m7.5 0-3.324 5.817a.375.375 0 0 1-.65 0L2.697 16.126c-.866-1.5.217-3.374 1.948-3.374h14.71c1.73 0 2.813 1.874 1.948 3.374L13.088 21.943a.375.375 0 0 1-.65 0Z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12.963 2.286a.375.375 0 0 0-.927 0L8.38 3.961a.375.375 0 0 0-.17.316v3.621a.375.375 0 0 0 .17.316l3.655 1.675a.375.375 0 0 0 .416 0l3.655-1.675a.375.375 0 0 0 .17-.316V4.277a.375.375 0 0 0-.17-.316L12.963 2.286Z" />
                    </svg>`,
                // Иконка для Магических Зелий (искра)
                'magic_potion': `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-purple-400">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.452-2.452L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.452-2.452L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.452 2.452L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.452 2.452ZM16.5 13.5h-3" />
                    </svg>`,
                default: `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-400">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>`
            };
            return icons[category] || icons.default;
        }

        /**
         * Отрисовывает полный список растений в Компендиуме.
         */
        function renderPlantList() {
            if (!plantListContainerEl) return; // Защита от раннего вызова

            // Получаем текущие значения фильтров
            const currentLocation = locationFilter.value;
            const isNight = nightToggle.checked;
            const currentTime = isNight ? 'night' : 'day';
            const currentCategory = categoryFilter.value;

            // Фильтруем базу данных
            const filteredPlants = plantDatabase.filter(plant => {
                const locationMatch = plant.locations.includes(currentLocation);
                const timeMatch = (plant.time === currentTime || plant.time === 'any');
                const categoryMatch = (currentCategory === 'all' || plant.category === currentCategory);
                return locationMatch && timeMatch && categoryMatch;
            });

            // Очищаем контейнер
            plantListContainerEl.innerHTML = '';

            if (filteredPlants.length === 0) {
                plantListContainerEl.innerHTML = '<p class="text-gray-400 italic">По вашим фильтрам ничего не найдено.</p>';
                return;
            }

            // Группируем по категориям
            const categories = {};
            filteredPlants.forEach(plant => {
                if (!categories[plant.category]) {
                    categories[plant.category] = [];
                }
                categories[plant.category].push(plant);
            });
            
            // Рендерим группы
            const categoryNames = {
                // ОБНОВЛЕНЫ НАЗВАНИЯ КАТЕГОРИЙ
                'potion': 'Ингредиенты Зелий', 
                'poison': 'Ингредиенты Ядов', 
                'magic_potion': 'Ингредиенты Магических Зелий'
            };

            // Сортируем категории
            const sortedCategories = Object.keys(categories).sort((a, b) => 
                categoryNames[a].localeCompare(categoryNames[b])
            );

            for (const categoryKey of sortedCategories) {
                const categoryName = categoryNames[categoryKey] || categoryKey;
                const plantsInCategory = categories[categoryKey];

                let categoryHtml = `
                    <div>
                        <h3 class="text-2xl font-semibold text-green-300 mt-6 border-b border-gray-700 pb-2 mb-4">
                            ${categoryName}
                        </h3>
                        <div class="space-y-3">
                `;

                // Сортируем растения в категории по имени
                plantsInCategory.sort((a, b) => a.name.localeCompare(b.name));

                plantsInCategory.forEach(plant => {
                    // --- НОВАЯ СТРУКТУРА КАРТОЧКИ-АККОРДЕОНА ---
                    categoryHtml += `
                        <div class="bg-gray-700 rounded-lg shadow-md overflow-hidden">
                            <!-- 1. Кликабельный Заголовок Карточки -->
                            <button class="plant-toggle-btn w-full flex items-center justify-between p-4 text-left hover:bg-gray-600 focus:outline-none focus:bg-gray-600 transition duration-150">
                                <div class="flex items-center">
                                    <!-- Иконка категории -->
                                    <span class="mr-3 flex-shrink-0">
                                        ${getCategoryIcon(plant.category)}
                                    </span>
                                    <!-- Название -->
                                    <h4 class="text-lg font-bold text-white">${plant.name}</h4>
                                </div>
                                <!-- Редкость -->
                                <span class="text-xs font-medium px-3 py-1 rounded-full ${getRarityClass(plant.rarity)} flex-shrink-0 ml-4">
                                    ${plant.rarity}
                                </span>
                            </button>
                            
                            <!-- 2. Скрытый Блок с Деталями -->
                            <div class="plant-details p-4 bg-gray-800 border-t border-gray-600 hidden">
                                <p class="text-sm text-gray-300 mb-3">${plant.description}</p>
                                <!-- Дополнительная информация (Теги) -->
                                <div class="flex flex-wrap gap-2">
                                    <span class="text-xs font-medium px-2 py-1 rounded-md bg-gray-600 text-gray-200">
                                        Время: ${plant.time === 'any' ? 'Любое' : (plant.time === 'day' ? 'День' : 'Ночь')}
                                    </span>
                                    <span class="text-xs font-medium px-2 py-1 rounded-md bg-gray-600 text-gray-200">
                                        Места: ${plant.locations.map(loc => {
                                            // ОБНОВЛЕНА ЛОГИКА ПОЛУЧЕНИЯ ИМЕНИ ЛОКАЦИИ
                                            const option = document.querySelector(`#location-filter option[value='${loc}']`);
                                            return option ? option.textContent : loc;
                                        }).join(', ')}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                    // --- КОНЕЦ НОВОЙ СТРУКТКТУРЫ ---
                });

                categoryHtml += '</div></div>';
                plantListContainerEl.innerHTML += categoryHtml;
            }
        }

        /**
         * Обрабатывает бросок d20 для ПОИСКА растений.
         */
        function handleSearchRoll() {
            const roll = rollDice(20);
            searchD20ResultEl.textContent = roll;

            // Очищаем предыдущие результаты сбора
            gatherD20ResultEl.textContent = '-';
            lootDisplayEl.innerHTML = '<p class="italic text-gray-400">Ожидание сбора...</p>';

            const currentLocation = locationFilter.value;
            const isNight = nightToggle.checked;
            const currentTime = isNight ? 'night' : 'day';

            // 1. Получаем ВСЕ доступные растения по фильтрам
            const availablePlants = plantDatabase.filter(plant => {
                // ОБНОВЛЕНА ЛОГИКА ФИЛЬТРАЦИИ
                // 1. Проверка локации (включая "povsemestno")
                const locationMatch = plant.locations.includes(currentLocation) || plant.locations.includes('povsemestno');
                // 2. Проверка времени (все 'any', но механика оставлена)
                const timeMatch = (plant.time === currentTime || plant.time === 'any');
                // 3. НЕ ФИЛЬТРУЕМ по типу (potion/poison) при поиске, чтобы находить всё
                // 4. Исключаем 'special' из поиска
                return locationMatch && timeMatch && !plant.locations.includes('special'); 
            });

            // 2. Разделяем их по редкости
            const lootPool = {
                common: availablePlants.filter(p => p.rarity === 'common'),
                uncommon: availablePlants.filter(p => p.rarity === 'uncommon'),
                rare: availablePlants.filter(p => p.rarity === 'rare'),
                very_rare: availablePlants.filter(p => p.rarity === 'very_rare')
            };

            // 3. Определяем добычу по результату броска
            let foundLoot = [];
            
            if (roll <= 5) {
                // Провал
                foundLoot.push({ name: "Ничего", description: "Вы ничего не нашли, кроме грязи." });
            } else if (roll <= 10) {
                // 1 Обычное
                foundLoot.push(getRandomPlant(lootPool.common, "Обычное растение не найдено"));
            } else if (roll <= 14) {
                // 2 Обычных
                foundLoot.push(getRandomPlant(lootPool.common, "Обычное растение не найдено"));
                foundLoot.push(getRandomPlant(lootPool.common, "Второе обычное не найдено"));
            } else if (roll <= 17) {
                // 1 Обычное, 1 Необычное
                foundLoot.push(getRandomPlant(lootPool.common, "Обычное растение не найдено"));
                foundLoot.push(getRandomPlant(lootPool.uncommon, "Необычное растение не найдено"));
            } else if (roll <= 19) {
                // 1 Необычное, 1 Редкое
                foundLoot.push(getRandomPlant(lootPool.uncommon, "Необычное растение не найдено"));
                foundLoot.push(getRandomPlant(lootPool.rare, "Редкое растение не найдено"));
            } else {
                // 20! 1 Редкое, 1 Очень Редкое
                foundLoot.push(getRandomPlant(lootPool.rare, "Редкое растение не найдено"));
                foundLoot.push(getRandomPlant(lootPool.very_rare, "Очень редкое растение не найдено!"));
            }

            // 4. Сохраняем найденное в глобальное состояние
            potentialLoot = foundLoot;

            // 5. Отображаем РЕЗУЛЬТАТЫ ПОИСКА
            renderSearchResults(foundLoot);

            // 6. Активируем/Деактивируем кнопку сбора
            const actualPlantsFound = potentialLoot.filter(p => p.rarity !== 'none' && p.name !== 'Ничего');
            if (actualPlantsFound.length > 0) {
                gatherBtn.disabled = false;
                gatherBtn.classList.remove('bg-gray-500', 'cursor-not-allowed', 'opacity-50');
                gatherBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                gatherBtn.disabled = true;
                gatherBtn.classList.add('bg-gray-500', 'cursor-not-allowed', 'opacity-50');
                gatherBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            }
        }

        /**
         * Обрабатывает бросок d20 для СБОРА растений из найденных.
         */
        function handleGatherRoll() {
            const gatherRoll = rollDice(20);
            gatherD20ResultEl.textContent = gatherRoll;

            const actualPlants = potentialLoot.filter(p => p.rarity !== 'none' && p.name !== 'Ничего');

            if (actualPlants.length === 0) {
                renderGatheredLoot([], gatherRoll); // Показать, что собирать было нечего
                return;
            }

            let gatheredCount = 0;
            
            if (gatherRoll <= 5) {
                // Провал
                gatheredCount = 0;
            } else if (gatherRoll <= 14) {
                // Частичный успех
                gatheredCount = 1;
            } else if (gatherRoll <= 19) {
                // Успех
                gatheredCount = 2;
            } else {
                // Крит. успех!
                gatheredCount = 99; // Собираем всё
            }

            // Берем N растений из найденных
            const finalLoot = actualPlants.slice(0, gatheredCount);

            // 4. Отображаем финальную добычу
            renderGatheredLoot(finalLoot, gatherRoll);

            // 5. Сбрасываем состояние
            potentialLoot = [];
            gatherBtn.disabled = true;
            gatherBtn.classList.add('bg-gray-500', 'cursor-not-allowed', 'opacity-50');
            gatherBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
        }

        /**
         * Выбирает случайное растение из массива.
         * @param {Array} plantArray - Массив растений.
         * @param {string} fallbackName - Сообщение, если массив пуст.
         * @returns {Object} - Объект растения или заглушка.
         */
        function getRandomPlant(plantArray, fallbackName = "Ничего") {
            if (!plantArray || plantArray.length === 0) {
                return { name: fallbackName, description: "В этой местности нет растений такой редкости.", rarity: "none" };
            }
            const index = Math.floor(Math.random() * plantArray.length);
            return plantArray[index];
        }

        /**
         * Отрисовывает найденную (потенциальную) добычу в списке ПОИСКА.
         * @param {Array} lootArray - Массив найденных растений.
         */
        function renderSearchResults(lootArray) {
            searchResultsDisplayEl.innerHTML = '';
            if (lootArray.length === 0) {
                searchResultsDisplayEl.innerHTML = '<p class="text-gray-400 italic">Произошла ошибка.</p>';
                return;
            }
            
            lootArray.forEach(plant => {
                if (plant.name === "Ничего") {
                    searchResultsDisplayEl.innerHTML = `<p class="italic text-gray-300">${plant.description}</p>`;
                    return; // Если "Ничего", не показываем другие
                }

                if (plant.rarity === "none") {
                     searchResultsDisplayEl.innerHTML += `
                        <div class="bg-gray-600 p-3 rounded-md mb-2 shadow">
                            <p class="font-medium text-gray-400">${plant.name}</p>
                            <p class="text-sm text-gray-400 italic">${plant.description}</p>
                        </div>
                    `;
                } else {
                    searchResultsDisplayEl.innerHTML += `
                        <div class="bg-blue-100 p-3 rounded-md mb-2 shadow">
                            <div class="flex justify-between items-center">
                                <h4 class="text-lg font-bold text-blue-900">${plant.name}</h4>
                                <span class="text-xs font-medium px-2 py-0.5 rounded-full ${getRarityClass(plant.rarity)}">
                                    ${plant.rarity}
                                </span>
                            </div>
                            <p class="text-sm text-blue-800">${plant.description}</p>
                        </div>
                    `;
                }
            });
        }

        /**
         * Отрисовывает СУЩЕСТВЕННО собранную добычу.
         * @param {Array} lootArray - Массив собранных растений.
         * @param {number} roll - Результат броска d20 на сбор.
         */
        function renderGatheredLoot(lootArray, roll) {
            lootDisplayEl.innerHTML = '';

            if (roll <= 5) {
                lootDisplayEl.innerHTML = `<p class="italic text-red-400 font-semibold">Провал сбора! Вы ничего не смогли собрать, или повредили найденное.</p>`;
                return;
            }
            
            if (lootArray.length === 0) {
                lootDisplayEl.innerHTML = `<p class="italic text-gray-400">Собирать было нечего.</p>`;
                return;
            }
            
            lootArray.forEach(plant => {
                // Используем тот же стиль, что и в `renderSearchResults`, но с зеленым оттенком
                lootDisplayEl.innerHTML += `
                    <div class="bg-green-100 p-3 rounded-md mb-2 shadow">
                        <div class="flex justify-between items-center">
                            <h4 class="text-lg font-bold text-green-900">${plant.name}</h4>
                            <!-- *** ИСПРАВЛЕНИЕ 2: Исправлена опечатка (было plant.rarDefine) *** -->
                            <span class="text-xs font-medium px-2 py-0.5 rounded-full ${getRarityClass(plant.rarity)}">
                                ${plant.rarity}
                            </span>
                        </div>
                        <p class="text-sm text-green-800">${plant.description}</p>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>
